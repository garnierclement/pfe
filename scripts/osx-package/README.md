# Creating an OS X Installer package

Create a `.pkg` installer for Mac OS X in order to provide an user friendly GUI to install Manticore.

**WARNING This a work in progress and does not work yet out of the box**

To create new packages, use the following script

	$ ./create-pkg.sh

In the current folder, you will find the newly created complete distribution `manticore-<version>.pkg` and all the packages that it is made of are in the folder `out`.

## Tree structure and entry point

The main script is `create-pkg.sh` and the tree structure of this folder is the following

* `launchd/`  
	*XML description files to register Manticore against `launchd`*
* `scripts/`  
	*`preinstall` and `postinstall` scripts for the .pkg generated by `pkgutil`*
* `resources/`  
	*resources folder used by `productbuild` and `distribution.xml` for the global package*
* `out/`  
	*temporary folder for `.pkg` files generated*
* `package/`  
	*copy of specific folders from the repository to be included in the main Manticore package for Mac OS X*

## Resources

* [Making OS X Installer Packages like a Pro]  (StackOverflow)
* [Empaqueter un démon pour OS X]
* [pkgbuild man page]  (Apple Developer)
* [pkgutil man page]  (Apple Developer)
* [productbuild man page]  (Apple Developer)
* [Creating payload-free packages with pkgbuild]
* [launchd.plist man page]  (Apple Developer)
* [launchd.info]
* [brew-pkg]
* [Packages]
* [Installer JavaScript Reference]  (Apple Developer) 
* [Distribution Definition XML Schema Reference]  (Apple Developer) 


[Making OS X Installer Packages like a Pro]: http://stackoverflow.com/questions/11487596/making-os-x-installer-packages-like-a-pro-xcode4-developer-id-mountain-lion-re
[Empaqueter un démon pour OS X]: http://vincent.bernat.im/fr/blog/2013-autoconf-osx-installeur.html#fnref:sdk
[pkgbuild man page]: https://developer.apple.com/library/mac/documentation/Darwin/Reference/Manpages/man1/pkgbuild.1.html#//apple_ref/doc/man/1/pkgbuild
[pkgutil man page]: https://developer.apple.com/library/mac/documentation/Darwin/Reference/Manpages/man1/pkgutil.1.html
[productbuild man page]: https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man1/productbuild.1.html
[Creating payload-free packages with pkgbuild]: http://derflounder.wordpress.com/2012/08/15/creating-payload-free-packages-with-pkgbuild/
[launchd.plist man page]: https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man5/launchd.plist.5.html
[launchd.info]: http://launchd.info/
[brew-pkg]: https://github.com/timsutton/brew-pkg
[Packages]: http://s.sudre.free.fr/Software/Packages/about.html
[Installer JavaScript Reference]:https://developer.apple.com/library/mac/documentation/DeveloperTools/Reference/InstallerJavaScriptRef/InstallerJavaScriptRef.pdf
[Distribution Definition XML Schema Reference]: https://developer.apple.com/library/mac/documentation/DeveloperTools/Reference/DistributionDefinitionRef/DistributionDefinitionRef.pdf

## Pre and post install scripts

* `pkgbuild` looks for scripts in files called `preinstall` and `postinstall`
* You can use `set -e` to exit immediately if a command exits with a non-zero status (if applicable)
* Remember to `chmod +x` the scripts otherwise the installation will fail during the execution of the scripts (and not only `chmod u+x`)
* Use `--nopayload` to create payload-free packages with `pkgbuild` (only scripts)

## Package for dependency from Homebrew

We use [brew-pkg] to build OS X installer packages directly from Homebrew formulae.

To install [brew-pkg]

	$ brew tap timsutton/formulae
	$ brew install brew-pkg

Then to create the required packages

	$ brew pkg --with-deps zeromq

## Create only scripts package

To create some only script packages, you can use the `--nopayload` option.

	$ pkgbuild --nopayload \
		--identifier <some_identifier> \
		--scripts <scripts_path> \
		output.pkg

## Quicklook plugin for packages

[Suspicious Package] is a plugin for the Quick Look feature of OS X. It allows you to preview the contents of a standard Apple installer package without launching the Installer.

[Suspicious Package]: http://www.mothersruin.com/software/SuspiciousPackage/download.html

## Keeping `distribution.xml` up to date

If you create new pacakges with `pkgbuild`, remember to add the identifier in the `distribution.xml` so that it can take the new ones into account.